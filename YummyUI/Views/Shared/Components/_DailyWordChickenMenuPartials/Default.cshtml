<style>
.ai-world{
  border-radius:18px;
  overflow:hidden;
  border:1px solid rgba(0,0,0,.06);
  box-shadow: 0 20px 60px rgba(0,0,0,.06);
  background:#fff;
}

.ai-world__header{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:16px;
  padding:16px 18px;
  background: linear-gradient(135deg, rgba(99,102,241,.10), rgba(56,189,248,.08));
  border-bottom:1px solid rgba(0,0,0,.05);
}

.ai-ticket{
  display:flex;
  align-items:flex-start;
  gap:14px;
  padding:18px 18px;
  border-bottom:1px solid rgba(0,0,0,.06);
  transition: .18s ease;
}
.ai-ticket:last-child{ border-bottom:none; }
.ai-ticket:hover{
  background: linear-gradient(135deg, rgba(79,70,229,.04), rgba(56,189,248,.03));
}

.ai-media{
  width:96px;
  height:96px;
  border-radius:18px;
  overflow:hidden;
  border:1px solid rgba(0,0,0,.08);
  flex:0 0 auto;
  background:#f7f7fb;
  box-shadow: 0 10px 24px rgba(0,0,0,.08);
}
.ai-media img{
  width:100%;
  height:100%;
  object-fit:cover;
  display:block;
}

.ai-content{
  flex:1;
  min-width:0;
}

.ai-top{
  display:flex;
  align-items:flex-start;
  justify-content:space-between;
  gap:12px;
}

.ai-title{
  font-weight:900;
  font-size:18px;
  color:#1f2430;
  margin:0;
  line-height:1.15;
  display:flex;
  align-items:center;
  gap:10px;
  min-width:0;
}

.ai-title a{
  color:#4f46e5;
  text-decoration:none;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
  max-width: 100%;
}
.ai-title a:hover{ text-decoration:underline; }

.ai-flag{
  width:22px;
  height:16px;
  border-radius:4px;
  border:1px solid rgba(0,0,0,.10);
  object-fit:cover;
  flex:0 0 auto;
}

.ai-desc{
  margin:10px 0 10px;
  color:#3c4250;
  font-weight:600;
}

.ai-meta{
  color:#7a8191;
  font-weight:700;
  display:flex;
  gap:10px;
  flex-wrap:wrap;
}

.ai-badge{
  padding:10px 16px;
  border-radius:999px;
  font-weight:900;
  border:1px solid rgba(0,0,0,.06);
  min-width: 92px;
  text-align:center;
  box-shadow: 0 10px 24px rgba(0,0,0,.06);
}

.ai-badge.kolay{ background: rgba(34,197,94,.14); color:#15803d; }
.ai-badge.orta { background: rgba(245,158,11,.18); color:#b45309; }
.ai-badge.zor  { background: rgba(239,68,68,.16); color:#b91c1c; }

.ai-tags{
  margin-top:12px;
  display:flex;
  gap:8px;
  flex-wrap:wrap;
}
.ai-tag{
  font-size:12px;
  font-weight:800;
  padding:7px 11px;
  border-radius:999px;
  background: rgba(79,70,229,.08);
  color:#4338ca;
  border:1px solid rgba(79,70,229,.12);
}
</style>

<div class="card ai-world">
  <div class="card-header ai-world__header">
    <div>
      <h4 class="mb-0">Yapay Zeka Destekli Dünya Mutfakları Önerileri</h4>
      <small class="text-muted">Sayfa yenilendikçe yeni öneriler</small>
    </div>
  </div>

  <div class="card-body p-0" id="aiWorldBody">
    <div class="p-3 text-muted">Yükleniyor…</div>
  </div>

  <a href="javascript:void(0)" id="aiWorldReload" class="card-footer card-link text-center small">Yenile</a>
</div>

<script>
(function () {
  const body = document.getElementById("aiWorldBody");
  const reload = document.getElementById("aiWorldReload");

  const esc = (s) => (s ?? "").toString()
    .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;");

  function badgeClass(d){
    const x = (d||"").toLowerCase();
    if (x.includes("kolay")) return "kolay";
    if (x.includes("zor")) return "zor";
    return "orta";
  }

  function flagUrl(code){
    const c = (code||"").toLowerCase().trim();
    if(!c) return "";
    return `https://flagcdn.com/w40/${c}.png`;
  }

  function foodImg(query){
  const q = encodeURIComponent((query||"food").trim());
  return `https://loremflickr.com/320/320/${q}?lock=${Date.now()}`;
}

  function render(items){
    body.innerHTML = "";
    if(!items || !items.length){
      body.innerHTML = `<div class="p-3 text-muted">Kayıt bulunamadı.</div>`;
      return;
    }

    items.forEach((it) => {
      const diff = it.difficulty || "Orta";
      const min = it.durationMin ?? 30;
      const tags = Array.isArray(it.tags) ? it.tags : [];

      body.insertAdjacentHTML("beforeend", `
        <div class="ai-ticket">
          <div class="ai-media">
            <img
              src="${esc(foodImg(it.imageQuery || it.dish))}"
              alt="${esc(it.dish)}"
              referrerpolicy="no-referrer"
              onerror="this.src='https://via.placeholder.com/300?text=Food';"
            />
          </div>

          <div class="ai-content">
            <div class="ai-top">
              <div class="ai-title">
                <img class="ai-flag"
                     src="${esc(flagUrl(it.countryCode))}"
                     alt="${esc(it.country)}"
                     referrerpolicy="no-referrer"
                     onerror="this.style.display='none';" />
                <a href="javascript:void(0)">${esc(it.country)} - ${esc(it.dish)}</a>
              </div>

              <div class="ai-badge ${esc(badgeClass(diff))}">${esc(diff)}</div>
            </div>

            <div class="ai-desc">${esc(it.description || "")}</div>

            <div class="ai-meta">
              <span>Süre: <b>${esc(min)} dk</b></span>
              <span>•</span>
              <span>Zorluk: <b>${esc(diff)}</b></span>
            </div>

            ${tags.length ? `
              <div class="ai-tags">
                ${tags.slice(0,6).map(t => `<span class="ai-tag">${esc(t)}</span>`).join("")}
              </div>` : ``}
          </div>
        </div>
      `);
    });
  }

  async function loadAI(){
    body.innerHTML = `<div class="p-3 text-muted">Yükleniyor…</div>`;

    try{
      const res = await fetch(`/AI/WorldFoods?_=${Date.now()}`, {
        cache: "no-store",
        headers: { "Accept": "application/json" }
      });

      const txt = await res.text();
      let json = null;

      try { json = JSON.parse(txt); }
      catch {
        body.innerHTML = `
          <div class="p-3 text-danger mb-2">
            AI Hatası: Sunucudan JSON gelmiyor. Gelen cevap:
          </div>
          <pre style="white-space:pre-wrap; background:#f7f7fb; padding:12px; border-radius:12px; margin: 0 12px 12px;">${esc(txt)}</pre>
        `;
        return;
      }

      if(!res.ok){
        body.innerHTML = `<div class="p-3 text-danger">HTTP Hata: ${res.status}<br><pre style="white-space:pre-wrap;">${esc(txt)}</pre></div>`;
        return;
      }

      if(!json || !json.ok){
        body.innerHTML = `<div class="p-3 text-danger">AI Hatası: ${esc(json?.message || "Bilinmeyen hata")}</div>`;
        return;
      }

      if(json.parseError){
        body.innerHTML = `
          <div class="p-3 text-danger mb-2">AI JSON parse edilemedi. Model JSON dışında içerik döndürmüş.</div>
          <pre style="white-space:pre-wrap; background:#f7f7fb; padding:12px; border-radius:12px; margin: 0 12px 12px;">${esc(json.dataRaw || "")}</pre>
        `;
        return;
      }

      const data = json.data;
      const items = data?.items || data?.Items || [];
      render(items);

    }catch(e){
      body.innerHTML = `<div class="p-3 text-danger">AI Hatası: ${esc(String(e))}</div>`;
    }
  }

  reload?.addEventListener("click", loadAI);
  loadAI();
})();
</script>
