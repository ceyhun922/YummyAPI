@using YummyUI.DTOs.TestimonialDTOs
@model CreateTestimonialDto
@{
    Layout = "_AdminLayout";
    ViewData["Title"] = "Yeni Müşteri Görüşü";
}

<div class="admin-create-page">

    <!-- Header -->
    <div class="page-hero">
        <div class="hero-left">
            <div class="hero-icon">
                <i class="fas fa-comment-dots"></i>
            </div>
            <div>
                <h1 class="hero-title">Yeni Müşteri Görüşü</h1>
                <p class="hero-subtitle">Başlıq, mesaj, şəkil və status əlavə edin.</p>
            </div>
        </div>

        <div class="hero-right">
            <span class="status-pill @(Model?.TestimonialStatus == true ? "is-active" : "is-passive")" id="heroStatusPill">
                <span class="dot"></span>
                <span id="heroStatusText">@(Model?.TestimonialStatus == true ? "Aktiv" : "Pasif")</span>
            </span>
        </div>
    </div>

    <div class="grid-2">
        <!-- LEFT: FORM -->
        <div class="glass-card">
            <div class="glass-card-header">
                <h3>Görüş əlavə etmə paneli</h3>
            </div>

            <div class="glass-card-body">
                @using (Html.BeginForm("CreateTestimonial", "Testimonial", FormMethod.Post,
                    new { @class = "glass-form", autocomplete = "off", enctype = "multipart/form-data" }))
                {
                    <div class="form-row">
                        <label class="form-label">Müştəri adı</label>
                        @Html.TextBoxFor(x => x.TestimonialName, new { @class = "glass-input", placeholder = "Örn: Elvin Məmmədov", id = "inpName" })
                        <small class="form-hint">Siyahıda və saytda bu ad görünəcək.</small>
                    </div>

                    <div class="form-row">
                        <label class="form-label">Vəzifə / Başlıq</label>
                        @Html.TextBoxFor(x => x.TestimonialTitle, new { @class = "glass-input", placeholder = "Örn: Müştəri / CEO / Menecer...", id = "inpTitle" })
                    </div>

                    <div class="form-row">
                        <label class="form-label">Mesaj</label>
                        @Html.TextAreaFor(x => x.TestimonialMessage, new { @class = "glass-textarea", rows = "5", placeholder = "Müştərinin rəyi burada yazılacaq...", id = "inpMsg" })
                    </div>

                    @* ✅ URL opsionaldır (DTO-da TestimonialImage varsa saxla) *@
                    <div class="form-row">
                        <label class="form-label">Şəkil URL (opsional)</label>
                        @Html.TextBoxFor(x => x.TestimonialImageUrl, new {
                            @class = "glass-input",
                            placeholder = "Örn: /Yummy/assets/img/testimonials/t-1.jpg",
                            id = "inpImgUrl",
                            autocomplete = "off"
                        })
                        <small class="form-hint">URL yazsan sağdakı önizləmədə görünəcək.</small>
                    </div>

                    <div class="form-row">
                        <label class="form-label">Şəkil Faylı</label>
                        <input type="file"
                               name="file"
                               id="inpImgFile"
                               class="glass-input"
                               accept=".jpg,.jpeg,.png,.webp" />
                        <small class="form-hint">Fayl seçsən canlı önizləmə dərhal yenilənəcək.</small>
                    </div>

                    <div class="form-row form-row-inline">
                        <div class="inline-left">
                            <label class="form-label">Status</label>
                            <small class="form-hint">Pasif olan rəylər saytda görünməyə bilər.</small>
                        </div>

                        <label class="switch">
                            @Html.CheckBoxFor(x => x.TestimonialStatus, new { id = "inpStatus" })
                            <span class="slider"></span>
                        </label>
                    </div>

                    <div class="form-actions">
                        <button class="btn-primary" type="submit">
                            <i class="fas fa-save"></i>
                            Save
                        </button>

                        <button class="btn-secondary" type="button" id="btnClear">
                            <i class="fas fa-broom"></i>
                            Önizlemeyi Temizle
                        </button>
                    </div>
                }
            </div>
        </div>

        <!-- RIGHT: LIVE PREVIEW -->
        <div class="glass-card">
            <div class="glass-card-header preview-header">
                <h3>Live Preview</h3>
            </div>

            <div class="glass-card-body">
                <div class="preview-card">
                    <div class="preview-top">
                        <div class="preview-avatar" id="prevAvatar">
                            <i class="fas fa-user"></i>
                        </div>

                        <div class="preview-meta">
                            <div class="preview-title" id="prevName">Başlıq burada görünəcək</div>
                            <div class="preview-subtitle" id="prevTitle">Alt başlıq burada görünəcək</div>
                        </div>

                        <span class="status-pill small is-passive" id="prevStatus">
                            <span class="dot"></span> Pasif
                        </span>
                    </div>

                    <div class="preview-image" id="prevImageWrap">
                        <div class="preview-image-placeholder" id="prevImgPh">
                            Resim önizlemesi burada görünecek.
                        </div>
                        <img id="prevImage" src="" alt="preview" style="display:none;" />
                    </div>

                    <div class="preview-message" id="prevMsg">
                        Açıklama burada görünecek.
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        (function () {
            const $ = (id) => document.getElementById(id);

            const elName   = $("inpName");
            const elTitle  = $("inpTitle");
            const elMsg    = $("inpMsg");
            const elImgUrl = $("inpImgUrl");   // URL input (opsional)
            const elImgFile= $("inpImgFile");  // file input
            const elStatus = $("inpStatus");

            const prevName   = $("prevName");
            const prevTitle  = $("prevTitle");
            const prevMsg    = $("prevMsg");
            const prevImage  = $("prevImage");
            const prevImageWrap = $("prevImageWrap");
            const prevImgPh  = $("prevImgPh");
            const prevStatus = $("prevStatus");

            const heroPill   = $("heroStatusPill");
            const heroText   = $("heroStatusText");

            const btnClear = $("btnClear");

            let lastObjectUrl = null; // file preview üçün cleanup

            function safeText(v, fallback) {
                const t = (v ?? "").trim();
                return t.length ? t : fallback;
            }

            function setStatus() {
                const isOn = !!elStatus.checked;

                // preview pill
                prevStatus.innerHTML = `<span class="dot"></span> ${isOn ? "Aktiv" : "Pasif"}`;
                prevStatus.classList.toggle("is-active", isOn);
                prevStatus.classList.toggle("is-passive", !isOn);

                // hero pill
                heroPill.classList.toggle("is-active", isOn);
                heroPill.classList.toggle("is-passive", !isOn);
                heroText.textContent = isOn ? "Aktiv" : "Pasif";
            }

            function showPlaceholder() {
                prevImage.style.display = "none";
                prevImage.src = "";
                prevImgPh.style.display = "flex";
            }

            function setImageFromUrl(url) {
                const u = (url || "").trim();
                if (!u) { showPlaceholder(); return; }

                prevImage.onload = () => {
                    prevImage.style.display = "block";
                    prevImgPh.style.display = "none";
                };
                prevImage.onerror = () => showPlaceholder();

                prevImage.src = u;
            }

            function setImageFromFile(file) {
                if (!file) { showPlaceholder(); return; }

                if (lastObjectUrl) URL.revokeObjectURL(lastObjectUrl);
                lastObjectUrl = URL.createObjectURL(file);

                prevImage.onload = () => {
                    prevImage.style.display = "block";
                    prevImgPh.style.display = "none";
                };
                prevImage.onerror = () => showPlaceholder();

                prevImage.src = lastObjectUrl;
            }

            function syncText() {
                prevName.textContent  = safeText(elName.value,  "Başlıq burada görünəcək");
                prevTitle.textContent = safeText(elTitle.value, "Alt başlıq burada görünəcək");
                prevMsg.textContent   = safeText(elMsg.value,   "Açıklama burada görünecek.");
            }

            function syncImage() {
                // 1) əgər file seçilibsə -> file üstünlük
                const f = elImgFile.files && elImgFile.files[0];
                if (f) { setImageFromFile(f); return; }

                // 2) yoxdursa URL-dən
                setImageFromUrl(elImgUrl ? elImgUrl.value : "");
            }

            function syncAll() {
                syncText();
                syncImage();
                setStatus();
            }

            // events
            ["input", "change", "keyup"].forEach(evt => {
                elName.addEventListener(evt, syncAll);
                elTitle.addEventListener(evt, syncAll);
                elMsg.addEventListener(evt, syncAll);
                if (elImgUrl) elImgUrl.addEventListener(evt, syncAll);
                elStatus.addEventListener(evt, syncAll);
            });

            elImgFile.addEventListener("change", syncAll);

            btnClear.addEventListener("click", function () {
                elName.value = "";
                elTitle.value = "";
                elMsg.value = "";
                if (elImgUrl) elImgUrl.value = "";
                elImgFile.value = "";
                elStatus.checked = false;

                if (lastObjectUrl) { URL.revokeObjectURL(lastObjectUrl); lastObjectUrl = null; }

                syncAll();
            });

            // initial
            syncAll();
        })();
    </script>
}
