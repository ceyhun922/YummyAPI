@using YummyUI.DTOs.TestimonialDTOs
@model GetByIdTestimonialDto
@{
    Layout = "_AdminLayout";
    ViewData["Title"] = "Müşteri Görüşü Güncəllə";
}

<div class="admin-create-page">

    <!-- Header -->
    <div class="page-hero">
        <div class="hero-left">
            <div class="hero-icon">
                <i class="fas fa-pen-nib"></i>
            </div>
            <div>
                <h1 class="hero-title">Müşteri Görüşü Güncəllə</h1>
                <p class="hero-subtitle">Məlumatları yeniləyin və sağdakı önizləmədə canlı görün.</p>
            </div>
        </div>

        <div class="hero-right">
            <span class="status-pill @(Model?.TestimonialStatus == true ? "is-active" : "is-passive")" id="topStatusPill">
                <span class="dot"></span>
                @(Model?.TestimonialStatus == true ? "Aktiv" : "Pasif")
            </span>
        </div>
    </div>

    <div class="grid-2">
        <!-- LEFT: FORM -->
        <div class="glass-card">
            <div class="glass-card-header">
                <h3>Görüş güncəlləmə paneli</h3>
            </div>

            <div class="glass-card-body">
                @using (Html.BeginForm("UpdateTestimonial", "Testimonial", FormMethod.Post, new { @class = "glass-form", autocomplete = "off" }))
                {
                    @Html.HiddenFor(x => x.TestimonialId)

                    <div class="form-row">
                        <label class="form-label">Müştəri adı</label>
                        @Html.TextBoxFor(x => x.TestimonialName, new { @class = "glass-input", placeholder = "Örn: Elvin Məmmədov", id = "inpName" })
                    </div>

                    <div class="form-row">
                        <label class="form-label">Vəzifə / Başlıq</label>
                        @Html.TextBoxFor(x => x.TestimonialTitle, new { @class = "glass-input", placeholder = "Örn: Müştəri / CEO / Menecer...", id = "inpTitle" })
                    </div>

                    <div class="form-row">
                        <label class="form-label">Mesaj</label>
                        @Html.TextAreaFor(x => x.TestimonialMessage, new { @class = "glass-textarea", rows = "5", placeholder = "Müştərinin rəyi burada yazılacaq...", id = "inpMsg" })
                    </div>

                    <div class="form-row">
                        <label class="form-label">Şəkil URL</label>
                        @Html.TextBoxFor(x => x.TestimonialImageUrl, new { @class = "glass-input", placeholder = "https://...", id = "inpImg" })
                        <small class="form-hint">Link düzgün olarsa şəkil sağdakı önizləmədə görünəcək.</small>
                    </div>

                    <div class="form-row form-row-inline">
                        <div class="inline-left">
                            <label class="form-label">Status</label>
                            <small class="form-hint">Pasif olan rəylər saytda görünməyə bilər.</small>
                        </div>

                        <label class="switch">
                            @Html.CheckBoxFor(x => x.TestimonialStatus, new { id = "inpStatus" })
                            <span class="slider"></span>
                        </label>
                    </div>

                    <div class="form-actions">
                        <button class="btn-primary" type="submit">
                            <i class="fas fa-save"></i>
                            Güncəllə
                        </button>

                        <a class="btn-secondary" href="/Testimonial/Index">
                            <i class="fas fa-arrow-left"></i>
                            Geri
                        </a>
                    </div>
                }
            </div>
        </div>

        <!-- RIGHT: LIVE PREVIEW -->
        <div class="glass-card">
            <div class="glass-card-header preview-header">
                <h3>Live Preview</h3>
            </div>

            <div class="glass-card-body">
                <div class="preview-card">
                    <div class="preview-top">
                        <div class="preview-avatar" id="prevAvatar">
                            <i class="fas fa-user"></i>
                        </div>

                        <div class="preview-meta">
                            <div class="preview-title" id="prevName">Başlıq burada görünəcək</div>
                            <div class="preview-subtitle" id="prevTitle">Alt başlıq burada görünəcək</div>
                        </div>

                        <span class="status-pill small" id="prevStatus">
                            <span class="dot"></span> Pasif
                        </span>
                    </div>

                    <div class="preview-image" id="prevImageWrap">
                        <div class="preview-image-placeholder">
                            Resim önizlemesi burada görünecek.
                        </div>
                        <img id="prevImage" src="" alt="preview" style="display:none;" />
                    </div>

                    <div class="preview-message" id="prevMsg">
                        Açıklama burada görünecek.
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        (function () {
            const elName = document.getElementById("inpName");
            const elTitle = document.getElementById("inpTitle");
            const elMsg = document.getElementById("inpMsg");
            const elImg = document.getElementById("inpImg");
            const elStatus = document.getElementById("inpStatus");

            const prevName = document.getElementById("prevName");
            const prevTitle = document.getElementById("prevTitle");
            const prevMsg = document.getElementById("prevMsg");

            const prevImage = document.getElementById("prevImage");
            const prevImageWrap = document.getElementById("prevImageWrap");
            const prevStatus = document.getElementById("prevStatus");
            const topStatusPill = document.getElementById("topStatusPill");

            function safeText(v, fallback) {
                const t = (v ?? "").trim();
                return t.length ? t : fallback;
            }

            function setStatus() {
                const isOn = !!elStatus.checked;

                prevStatus.innerHTML = `<span class="dot"></span> ${isOn ? "Aktiv" : "Pasif"}`;
                prevStatus.classList.toggle("is-active", isOn);
                prevStatus.classList.toggle("is-passive", !isOn);

                if (topStatusPill) {
                    topStatusPill.innerHTML = `<span class="dot"></span> ${isOn ? "Aktiv" : "Pasif"}`;
                    topStatusPill.classList.toggle("is-active", isOn);
                    topStatusPill.classList.toggle("is-passive", !isOn);
                }
            }

            function setImage() {
                const url = (elImg.value || "").trim();
                const placeholder = prevImageWrap.querySelector(".preview-image-placeholder");

                if (!url) {
                    prevImage.style.display = "none";
                    prevImage.src = "";
                    if (placeholder) placeholder.style.display = "flex";
                    return;
                }

                prevImage.src = url;
                prevImage.onload = () => {
                    prevImage.style.display = "block";
                    if (placeholder) placeholder.style.display = "none";
                };
                prevImage.onerror = () => {
                    prevImage.style.display = "none";
                    if (placeholder) placeholder.style.display = "flex";
                };
            }

            function sync() {
                prevName.textContent = safeText(elName.value, "Başlıq burada görünəcək");
                prevTitle.textContent = safeText(elTitle.value, "Alt başlıq burada görünəcək");
                prevMsg.textContent = safeText(elMsg.value, "Açıklama burada görünecek.");
                setImage();
                setStatus();
            }

            ["input", "change", "keyup"].forEach(evt => {
                elName.addEventListener(evt, sync);
                elTitle.addEventListener(evt, sync);
                elMsg.addEventListener(evt, sync);
                elImg.addEventListener(evt, sync);
                elStatus.addEventListener(evt, sync);
            });

            // initial sync (pre-filled values on update)
            sync();
        })();
    </script>
}
