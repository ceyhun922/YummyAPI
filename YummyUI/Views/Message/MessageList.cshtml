@using YummyUI.DTOs.MessageDTOs
@model List<ResultMessageDto>

@{
  Layout = "_AdminLayout";

  // server-side: Controller'dan bas
  var active = (ViewBag.ActiveBox as string ?? "inbox").ToLower(); // inbox | archive | trash
  int cntInbox = ViewBag.CntInbox ?? 0;
  int cntArchive = ViewBag.CntArchive ?? 0;
  int cntTrash = ViewBag.CntTrash ?? 0;
}

@section Styles {
  <style>
    /* ===== PREMIUM GLASS BASE ===== */
    .ai-msg,
    .ai-msg * {
      box-sizing: border-box;
    }

    .ai-msg {
      min-height: 100%;
      padding: 1.6rem 2rem 2.5rem;
      position: relative;
      overflow: hidden;
      background:
        radial-gradient(1200px 600px at 70% 80%, rgba(56, 189, 248, .18), transparent 60%),
        radial-gradient(900px 500px at 15% 20%, rgba(139, 92, 246, .22), transparent 60%),
        radial-gradient(800px 420px at 90% 10%, rgba(99, 102, 241, .18), transparent 55%),
        linear-gradient(135deg, #070b1f 0%, #0a1030 40%, #050818 100%);
    }

    .orb {
      position: absolute;
      border-radius: 999px;
      filter: blur(90px);
      opacity: .55;
      pointer-events: none;
      animation: floaty 14s ease-in-out infinite;
    }

    .orb.a {
      width: 480px;
      height: 480px;
      left: -150px;
      top: -150px;
      background: rgba(139, 92, 246, .40);
    }

    .orb.b {
      width: 420px;
      height: 420px;
      right: -160px;
      top: 120px;
      background: rgba(56, 189, 248, .34);
      animation-delay: 3s;
    }

    .orb.c {
      width: 520px;
      height: 520px;
      left: 35%;
      bottom: -240px;
      background: rgba(99, 102, 241, .30);
      animation-delay: 6s;
    }

    @@keyframes floaty {

      0%,
      100% {
        transform: translate(0, 0) scale(1);
      }

      50% {
        transform: translate(16px, -12px) scale(1.04);
      }
    }

    /* header */
    .head {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 1rem;
      margin-bottom: 1rem;
      position: relative;
      z-index: 3;
    }

    .head-left {
      display: flex;
      align-items: center;
      gap: .9rem;
    }

    .badge {
      width: 56px;
      height: 56px;
      border-radius: 18px;
      display: grid;
      place-items: center;
      background: linear-gradient(135deg, rgba(99, 102, 241, .55), rgba(139, 92, 246, .55));
      border: 1px solid rgba(255, 255, 255, .16);
      box-shadow: 0 18px 50px rgba(99, 102, 241, .35);
      backdrop-filter: blur(12px);
    }

    .badge span {
      font-size: 1.7rem;
    }

    .titles h1 {
      margin: 0;
      font-size: 2.1rem;
      font-weight: 900;
      letter-spacing: .2px;
      background: linear-gradient(135deg, #ffffff, #a8b9ff);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .titles p {
      margin: .2rem 0 0;
      color: rgba(255, 255, 255, .65);
      font-weight: 600;
    }

    .btn-add {
      display: inline-flex;
      align-items: center;
      gap: .6rem;
      padding: 1rem 1.35rem;
      border-radius: 18px;
      font-weight: 900;
      color: #0b1026;
      text-decoration: none;
      background: linear-gradient(135deg, #fbbf24, #f59e0b);
      box-shadow: 0 18px 55px rgba(245, 158, 11, .35);
      border: 1px solid rgba(255, 255, 255, .18);
    }

    .btn-add:hover {
      filter: brightness(1.04);
      transform: translateY(-1px);
      transition: .2s;
    }

    /* tabs + search */
    .glass {
      background: rgba(15, 23, 42, .55);
      border-radius: 28px;
      border: 1px solid rgba(255, 255, 255, .12);
      backdrop-filter: blur(16px);
      box-shadow: 0 40px 90px rgba(0, 0, 0, .45);
      overflow: hidden;
      position: relative;
      z-index: 3;
    }

    .toolbar {
      padding: 1.1rem 1.2rem;
      border-bottom: 1px solid rgba(255, 255, 255, .08);
      background: linear-gradient(180deg, rgba(10, 14, 39, .45), rgba(10, 14, 39, .18));
    }

    .row {
      display: flex;
      gap: .8rem;
      align-items: center;
      flex-wrap: wrap;
    }

    .search {
      flex: 1;
      min-width: 260px;
      display: flex;
      align-items: center;
      gap: .7rem;
      padding: .95rem 1.1rem;
      border-radius: 22px;
      background: rgba(7, 10, 25, .45);
      border: 1px solid rgba(255, 255, 255, .10);
    }

    .search input {
      width: 100%;
      border: none;
      outline: none;
      background: transparent;
      color: rgba(255, 255, 255, .9);
      font-weight: 800;
    }

    .tabs {
      display: flex;
      gap: .55rem;
      flex-wrap: wrap;
    }

    .tab {
      border: 1px solid rgba(255, 255, 255, .12);
      background: rgba(255, 255, 255, .06);
      color: rgba(255, 255, 255, .78);
      padding: .6rem .95rem;
      border-radius: 999px;
      font-weight: 900;
      font-size: .85rem;
      cursor: pointer;
      user-select: none;
      transition: .2s;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: .5rem;
    }

    .tab:hover {
      transform: translateY(-1px);
    }

    .tab.active {
      background: linear-gradient(135deg, rgba(99, 102, 241, .55), rgba(139, 92, 246, .55));
      border-color: rgba(255, 255, 255, .22);
      color: #fff;
      box-shadow: 0 18px 55px rgba(99, 102, 241, .25);
    }

    .count-pill {
      padding: .18rem .55rem;
      border-radius: 999px;
      background: rgba(255, 255, 255, .10);
      border: 1px solid rgba(255, 255, 255, .16);
      font-weight: 950;
      font-size: .75rem;
    }

    /* list */
    .list {
      padding: .6rem;
    }

    .item {
      display: flex;
      gap: 1rem;
      align-items: flex-start;
      padding: 1rem 1.1rem;
      border-radius: 22px;
      border: 1px solid rgba(255, 255, 255, .08);
      background: rgba(255, 255, 255, .04);
      margin: .6rem;
      transition: .2s;
    }

    .item:hover {
      transform: translateY(-1px);
      background: rgba(102, 126, 234, .08);
    }

    .avatar {
      width: 46px;
      height: 46px;
      border-radius: 16px;
      display: grid;
      place-items: center;
      background: linear-gradient(135deg, rgba(99, 102, 241, .55), rgba(139, 92, 246, .55));
      border: 1px solid rgba(255, 255, 255, .14);
      font-weight: 950;
      color: #fff;
      flex: 0 0 auto;
    }

    .meta {
      flex: 1;
      min-width: 0;
    }

    .line1 {
      display: flex;
      gap: .6rem;
      align-items: center;
      flex-wrap: wrap;
    }

    .name {
      font-weight: 950;
      color: #fff;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 320px;
    }

    .mail {
      color: rgba(255, 255, 255, .65);
      font-weight: 700;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 320px;
    }

    .subj {
      margin: .25rem 0 0;
      color: rgba(255, 255, 255, .88);
      font-weight: 900;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .snip {
      margin: .35rem 0 0;
      color: rgba(255, 255, 255, .70);
      font-weight: 650;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .right {
      margin-left: auto;
      display: flex;
      gap: .5rem;
      align-items: center;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .tag {
      padding: .45rem .8rem;
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, .12);
      background: rgba(255, 255, 255, .06);
      color: rgba(255, 255, 255, .82);
      font-weight: 900;
      font-size: .78rem;
    }

    .tag.unread {
      background: linear-gradient(135deg, #fbbf24, #f59e0b);
      color: #1a1a1a;
      border-color: rgba(255, 255, 255, .18);
    }

    /* action buttons */
    .btnMini {
      border: none;
      border-radius: 14px;
      padding: .55rem .75rem;
      font-weight: 950;
      cursor: pointer;
      border: 1px solid rgba(255, 255, 255, .12);
      background: rgba(255, 255, 255, .06);
      color: #fff;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: .45rem;
    }

    .btnMini.danger {
      background: linear-gradient(135deg, #ef4444, #dc2626);
      border: none;
    }

    .btnMini.primary {
      background: linear-gradient(135deg, #fbbf24, #f59e0b);
      color: #1a1a1a;
      border: none;
    }

    .btnMini.purple {
      background: linear-gradient(135deg, rgba(99, 102, 241, .7), rgba(139, 92, 246, .7));
      border: none;
    }

    .btnMini:hover {
      transform: translateY(-1px);
      transition: .2s;
    }

    .btnMini:disabled {
      opacity: .6;
      cursor: not-allowed;
      transform: none;
    }

    .muted-empty {
      padding: 2rem;
      color: rgba(255, 255, 255, .7);
      font-weight: 800
    }

    /* small form reset */
    .actForm {
      display: inline;
    }

    .actForm button {
      appearance: none;
      -webkit-appearance: none;
    }

    /* ===== TOAST ===== */
    .toast {
      position: fixed;
      right: 18px;
      bottom: 18px;
      padding: 12px 14px;
      border-radius: 16px;
      background: rgba(15, 23, 42, .72);
      border: 1px solid rgba(255, 255, 255, .14);
      backdrop-filter: blur(14px);
      color: rgba(255, 255, 255, .9);
      box-shadow: 0 30px 70px rgba(0, 0, 0, .5);
      display: none;
      gap: 10px;
      align-items: flex-start;
      max-width: 360px;
      z-index: 9999;
    }

    .toast.show {
      display: flex;
      animation: pop .18s ease-out;
    }

    @@keyframes pop {
      from {
        transform: translateY(8px);
        opacity: 0
      }

      to {
        transform: translateY(0);
        opacity: 1
      }
    }

    .toast .t-title {
      font-weight: 950;
      margin: 0;
      font-size: .95rem;
    }

    .toast .t-desc {
      margin: .15rem 0 0;
      color: rgba(255, 255, 255, .72);
      font-weight: 650;
      font-size: .85rem;
    }

    .toast .x {
      margin-left: auto;
      cursor: pointer;
      opacity: .85;
      font-weight: 900;
    }
  </style>
}

<div class="ai-msg">
  <div class="orb a"></div>
  <div class="orb b"></div>
  <div class="orb c"></div>

  <div class="head">
    <div class="head-left">
      <div class="badge"><span>‚úâÔ∏è</span></div>
      <div class="titles">
        <h1>Mesajlar</h1>
        <p>Inbox ‚Ä¢ Archive ‚Ä¢ Trash (Server-side tab) ‚Ä¢ Only search JS</p>
      </div>
    </div>

    <a class="btn-add" href="javascript:void(0)">‚ûï Yeni Mesaj</a>
  </div>

  <div class="glass">
    <div class="toolbar">
      <div class="row">
        <div class="search">
          <span>üîé</span>
          <input id="q" type="text" placeholder="ƒ∞sim, mail, subject, mesaj..." autocomplete="off" />
        </div>

        <div class="tabs">
          <a class="tab @(active == "inbox" ? "active" : "")" href="/Message/MessageList?box=inbox">
            Hepsi <span class="count-pill">@cntInbox</span>
          </a>
          <a class="tab @(active == "archive" ? "active" : "")" href="/Message/MessageList?box=archive">
            Ar≈üiv <span class="count-pill">@cntArchive</span>
          </a>
          <a class="tab @(active == "trash" ? "active" : "")" href="/Message/MessageList?box=trash">
            √á√∂p <span class="count-pill">@cntTrash</span>
          </a>
        </div>
      </div>
    </div>

    <div class="list" id="list">
      @if (Model != null && Model.Any())
      {
        foreach (var m in Model)
        {
          var initial = string.IsNullOrWhiteSpace(m.FullName) ? "?" : m.FullName.Trim().Substring(0, 1).ToUpper();
          var snippet = (m.Message ?? "");
          if (snippet.Length > 120) snippet = snippet.Substring(0, 120) + "...";

          var searchText = $"{m.FullName} {m.Email} {m.Subject} {m.Message}".ToLowerInvariant();

          <div class="item" data-search="@searchText">
            <div class="avatar">@initial</div>

            <div class="meta">
              <div class="line1">
                <div class="name">@m.FullName</div>
                <div class="mail">‚Ä¢ @m.Email</div>
              </div>
              <div class="subj">@m.Subject</div>
              <div class="snip">@snippet</div>
            </div>

            <div class="right">
              <div class="tag @(m.IsRead ? "" : "unread")">@(m.IsRead ? "Okundu" : "Yeni")</div>

              <a href="/Message/MessageDetail/@m.ContactId" class="btnMini purple">üëÅ Mesajƒ± A√ß</a>

              @if (active == "trash")
              {
                <form class="actForm" method="post" action="/Message/MessageRestore">
                  <input type="hidden" name="id" value="@m.ContactId" />
                  <button type="submit" class="btnMini purple">‚Ü© Geri Al</button>
                </form>

                <form class="actForm" method="post" action="/Message/MessageDelete">
                  <input type="hidden" name="id" value="@m.ContactId" />
                  <button type="submit" class="btnMini danger">üóë Kalƒ±cƒ± Sil</button>
                </form>
              }
              else
              {
                <button type="button" data-id="@m.ContactId" class="btnMini purple js-archive"> Ar≈üivle</button>

                <form class="actForm" method="post" action="/Message/MessageTrash">
                  <input type="hidden" name="id" value="@m.ContactId" />
                  <button type="submit" class="btnMini danger">üóë √á√∂pe Ta≈üƒ±</button>
                </form>
              }
            </div>
          </div>
        }
      }
      else
      {
        <div class="muted-empty">
          @(active == "trash" ? "√á√∂p bo≈ü." : active == "archive" ? "Ar≈üiv bo≈ü." : "Mesaj yok.")
        </div>
      }
    </div>
  </div>

  <!-- Toast -->
  <div class="toast" id="toast">
    <div>
      <p class="t-title" id="tTitle">Vaooo ‚ú®</p>
      <p class="t-desc" id="tDesc">ƒ∞≈ülem tamamlandƒ±.</p>
    </div>
    <div class="x" id="tClose">‚úñ</div>
  </div>
</div>

@section Scripts {
  <script>
    /* =========================
       TEK JS: SEARCH + TOAST
       ========================= */
    (() => {
      // ---- Toast ----
      const toastEl = document.getElementById("toast");
      const tTitle = document.getElementById("tTitle");
      const tDesc = document.getElementById("tDesc");
      const tClose = document.getElementById("tClose");

      function toast(desc, title = "Vaooo ‚ú®") {
        if (!toastEl) return;
        if (tTitle) tTitle.textContent = title;
        if (tDesc) tDesc.textContent = desc || "";
        toastEl.classList.add("show");
        clearTimeout(window.__t);
        window.__t = setTimeout(() => toastEl.classList.remove("show"), 2200);
      }
      tClose?.addEventListener("click", () => toastEl?.classList.remove("show"));


      //----- ARCHIVED FETCH-----
      document.addEventListener("click", async (e) => {
        const btn = e.target.closest(".js-archive");
        if (!btn) return;

        const id = btn.getAttribute("data-id");

        if (!id) return;

        btn.disabled = true;

        try {
          const res = await fetch("/Message/MessageArchive", {
            method: "POST",
            headers: {
              "Content-Type": "application/x-www-form-urlencoded"
            },
            body: "id=" + encodeURIComponent(id)
          });

          if (!res.ok) throw new Error("Server error");

          const item = btn.closest(".item");
          if (item) item.remove();

          toast("Ar≈üivlendi", "Ba≈üarƒ±lƒ±");



        } catch (err) {
          console.error(err);
          toast("Ar≈üivlenemedi", "Hata!");
          btn.disabled = false;
        }

      })


      // ---- Search ----
      const q = document.getElementById("q");
      const list = document.getElementById("list");
      if (!q || !list) return;

      const items = Array.from(list.querySelectorAll(".item"));

      function applySearch() {
        const needle = (q.value || "").trim().toLowerCase();
        items.forEach(it => {
          const hay = (it.getAttribute("data-search") || "");
          const ok = !needle || hay.includes(needle);
          it.style.display = ok ? "" : "none";
        });
      }
      q.addEventListener("input", applySearch);

      // ---- Form submit toast (server-side post olacaq) ----
      document.addEventListener("submit", (e) => {
        const f = e.target;
        if (!f || !f.matches("form.actForm")) return;

        const act = (f.getAttribute("action") || "").toLowerCase();

        if (act.includes("messagetrash")) toast("Mesaj √ß√∂pe ta≈üƒ±nƒ±yor‚Ä¶", "ƒ∞≈üleniyor ‚è≥");
        else if (act.includes("messagearchive")) toast("Mesaj ar≈üive ta≈üƒ±nƒ±yor‚Ä¶", "ƒ∞≈üleniyor ‚è≥");
        else if (act.includes("messagerestore")) toast("Mesaj geri alƒ±nƒ±yor‚Ä¶", "ƒ∞≈üleniyor ‚è≥");
        else if (act.includes("messagedelete")) toast("Mesaj kalƒ±cƒ± siliniyor‚Ä¶", "ƒ∞≈üleniyor ‚è≥");
        else toast("ƒ∞≈ülem yapƒ±lƒ±yor‚Ä¶", "ƒ∞≈üleniyor ‚è≥");
      });

      // ---- TempData toast (redirect sonrasƒ±) ----
      const serverMsg = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(TempData["ToastMessage"]));
      const serverTitle = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(TempData["ToastTitle"]));

      if (serverMsg) {
        toast(serverMsg, serverTitle || "Tamam ‚úÖ");
      }


    })();
  </script>
}