@using YummyUI.DTOs.MessageDTOs
@model List<ResultMessageDto>
@{
  Layout = "_AdminLayout";
}
@section Styles
{
<style>
/* ===== PREMIUM GLASS BASE ===== */
.ai-msg, .ai-msg *{ box-sizing:border-box; }
.ai-msg{
  min-height:100%;
  padding:1.6rem 2rem 2.5rem;
  position:relative; overflow:hidden;
  background:
    radial-gradient(1200px 600px at 70% 80%, rgba(56,189,248,.18), transparent 60%),
    radial-gradient(900px 500px at 15% 20%, rgba(139,92,246,.22), transparent 60%),
    radial-gradient(800px 420px at 90% 10%, rgba(99,102,241,.18), transparent 55%),
    linear-gradient(135deg, #070b1f 0%, #0a1030 40%, #050818 100%);
}
.orb{position:absolute;border-radius:999px;filter:blur(90px);opacity:.55;pointer-events:none;animation:floaty 14s ease-in-out infinite;}
.orb.a{width:480px;height:480px;left:-150px;top:-150px;background:rgba(139,92,246,.40);}
.orb.b{width:420px;height:420px;right:-160px;top:120px;background:rgba(56,189,248,.34);animation-delay:3s;}
.orb.c{width:520px;height:520px;left:35%;bottom:-240px;background:rgba(99,102,241,.30);animation-delay:6s;}
@@keyframes floaty{0%,100%{transform:translate(0,0) scale(1);}50%{transform:translate(16px,-12px) scale(1.04);}}

/* header */
.head{display:flex;align-items:flex-start;justify-content:space-between;gap:1rem;margin-bottom:1rem;position:relative;z-index:3;}
.head-left{display:flex;align-items:center;gap:.9rem;}
.badge{
  width:56px;height:56px;border-radius:18px;display:grid;place-items:center;
  background:linear-gradient(135deg, rgba(99,102,241,.55), rgba(139,92,246,.55));
  border:1px solid rgba(255,255,255,.16);
  box-shadow:0 18px 50px rgba(99,102,241,.35);
  backdrop-filter:blur(12px);
}
.badge span{font-size:1.7rem;}
.titles h1{
  margin:0;font-size:2.1rem;font-weight:900;letter-spacing:.2px;
  background:linear-gradient(135deg,#ffffff,#a8b9ff);
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;
}
.titles p{margin:.2rem 0 0;color:rgba(255,255,255,.65);font-weight:600;}

.btn-add{
  display:inline-flex;align-items:center;gap:.6rem;
  padding:1rem 1.35rem;border-radius:18px;
  font-weight:900;color:#0b1026;text-decoration:none;
  background:linear-gradient(135deg,#fbbf24,#f59e0b);
  box-shadow:0 18px 55px rgba(245,158,11,.35);
  border:1px solid rgba(255,255,255,.18);
}
.btn-add:hover{filter:brightness(1.04);transform:translateY(-1px);transition:.2s;}

/* tabs + search */
.glass{
  background:rgba(15,23,42,.55);
  border-radius:28px;
  border:1px solid rgba(255,255,255,.12);
  backdrop-filter:blur(16px);
  box-shadow:0 40px 90px rgba(0,0,0, .45);
  overflow:hidden;
  position:relative;z-index:3;
}
.toolbar{
  padding:1.1rem 1.2rem;
  border-bottom:1px solid rgba(255,255,255,.08);
  background:linear-gradient(180deg, rgba(10,14,39,.45), rgba(10,14,39,.18));
}
.row{display:flex;gap:.8rem;align-items:center;flex-wrap:wrap;}
.search{
  flex:1;min-width:260px;
  display:flex;align-items:center;gap:.7rem;
  padding:.95rem 1.1rem;border-radius:22px;
  background:rgba(7,10,25,.45);
  border:1px solid rgba(255,255,255,.10);
}
.search input{width:100%;border:none;outline:none;background:transparent;color:rgba(255,255,255,.9);font-weight:800;}
.tabs{display:flex;gap:.55rem;flex-wrap:wrap;}
.tab{
  border:1px solid rgba(255,255,255,.12);
  background:rgba(255,255,255,.06);
  color:rgba(255,255,255,.78);
  padding:.6rem .95rem;border-radius:999px;
  font-weight:900;font-size:.85rem;
  cursor:pointer;user-select:none;transition:.2s;
  text-decoration:none;display:inline-flex;align-items:center;gap:.5rem;
}
.tab:hover{transform:translateY(-1px);}
.tab.active{
  background:linear-gradient(135deg, rgba(99,102,241,.55), rgba(139,92,246,.55));
  border-color:rgba(255,255,255,.22);
  color:#fff;box-shadow:0 18px 55px rgba(99,102,241,.25);
}
.count-pill{
  padding:.18rem .55rem;border-radius:999px;
  background:rgba(255,255,255,.10);
  border:1px solid rgba(255,255,255,.16);
  font-weight:950;font-size:.75rem;
}

/* list */
.list{padding:.6rem;}
.item{
  display:flex;gap:1rem;align-items:flex-start;
  padding:1rem 1.1rem;border-radius:22px;
  border:1px solid rgba(255,255,255,.08);
  background:rgba(255,255,255,.04);
  margin:.6rem;
  cursor:pointer;
  transition:.2s;
}
.item:hover{transform:translateY(-1px);background:rgba(102,126,234,.08);}
.avatar{
  width:46px;height:46px;border-radius:16px;
  display:grid;place-items:center;
  background:linear-gradient(135deg, rgba(99,102,241,.55), rgba(139,92,246,.55));
  border:1px solid rgba(255,255,255,.14);
  font-weight:950;color:#fff;
  flex:0 0 auto;
}
.meta{flex:1;min-width:0;}
.line1{display:flex;gap:.6rem;align-items:center;flex-wrap:wrap;}
.name{font-weight:950;color:#fff;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:320px;}
.mail{color:rgba(255,255,255,.65);font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:320px;}
.subj{margin:.25rem 0 0;color:rgba(255,255,255,.88);font-weight:900;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.snip{margin:.35rem 0 0;color:rgba(255,255,255,.70);font-weight:650;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;}
.right{margin-left:auto;display:flex;gap:.5rem;align-items:center;}
.tag{
  padding:.45rem .8rem;border-radius:999px;
  border:1px solid rgba(255,255,255,.12);
  background:rgba(255,255,255,.06);
  color:rgba(255,255,255,.82);
  font-weight:900;font-size:.78rem;
}
.tag.unread{background:linear-gradient(135deg,#fbbf24,#f59e0b);color:#1a1a1a;border-color:rgba(255,255,255,.18);}

/* action buttons */
.btnMini{
  border:none;border-radius:14px;padding:.55rem .75rem;
  font-weight:950;cursor:pointer;
  border:1px solid rgba(255,255,255,.12);
  background:rgba(255,255,255,.06);
  color:#fff;
}
.btnMini.danger{background:linear-gradient(135deg,#ef4444,#dc2626);border:none;}
.btnMini.primary{background:linear-gradient(135deg,#fbbf24,#f59e0b);color:#1a1a1a;border:none;}
.btnMini.purple{background:linear-gradient(135deg, rgba(99,102,241,.7), rgba(139,92,246,.7));border:none;}
.btnMini:hover{transform:translateY(-1px);transition:.2s;}
.btnMini:disabled{opacity:.6;cursor:not-allowed;transform:none;}

/* modal */
.backdrop{
  position:fixed;inset:0;background:rgba(0,0,0,.55);
  display:none;align-items:center;justify-content:center;
  z-index:9998;
}
.backdrop.show{display:flex;}
.modal{
  width:min(920px, 92vw);
  border-radius:28px;
  background:rgba(15,23,42,.78);
  border:1px solid rgba(255,255,255,.14);
  backdrop-filter:blur(16px);
  box-shadow:0 50px 120px rgba(0,0,0,.6);
  overflow:hidden;
}
.m-head{
  padding:1.1rem 1.2rem;
  display:flex;align-items:center;justify-content:space-between;gap:1rem;
  border-bottom:1px solid rgba(255,255,255,.10);
  background:linear-gradient(180deg, rgba(10,14,39,.55), rgba(10,14,39,.20));
}
.m-title{margin:0;color:#fff;font-weight:950;font-size:1.1rem;}
.m-close{cursor:pointer;opacity:.85;font-weight:950;color:#fff;}
.m-body{padding:1.2rem;display:grid;grid-template-columns: 1.25fr .75fr;gap:1rem;}
@@media(max-width:900px){.m-body{grid-template-columns:1fr;}}
.card{
  border-radius:22px;
  border:1px solid rgba(255,255,255,.12);
  background:rgba(255,255,255,.06);
  padding:1rem;
}
.kv{display:grid;grid-template-columns:110px 1fr;gap:.55rem .8rem;align-items:start;}
.k{color:rgba(255,255,255,.65);font-weight:800;}
.v{color:rgba(255,255,255,.92);font-weight:800;word-break:break-word;}
.textarea{
  width:100%;min-height:160px;
  border-radius:18px;
  border:1px solid rgba(255,255,255,.12);
  background:rgba(7,10,25,.45);
  color:rgba(255,255,255,.92);
  padding:.9rem 1rem;
  outline:none;
  font-weight:700;
  resize:vertical;
}
.m-actions{display:flex;gap:.6rem;flex-wrap:wrap;justify-content:flex-end;margin-top:.7rem;}

/* toast */
.toast{
  position:fixed;right:18px;bottom:18px;
  padding:12px 14px;border-radius:16px;
  background:rgba(15,23,42,.72);
  border:1px solid rgba(255,255,255,.14);
  backdrop-filter:blur(14px);
  color:rgba(255,255,255,.9);
  box-shadow:0 30px 70px rgba(0,0,0,.5);
  display:none;gap:10px;align-items:flex-start;
  max-width:340px;z-index:9999;
}
.toast.show{display:flex;animation:pop .18s ease-out;}
@@keyframes pop{from{transform:translateY(8px);opacity:0}to{transform:translateY(0);opacity:1}}
.toast .t-title{font-weight:950;margin:0;font-size:.95rem;}
.toast .t-desc{margin:.15rem 0 0;color:rgba(255,255,255,.72);font-weight:650;font-size:.85rem;}
.toast .x{margin-left:auto;cursor:pointer;opacity:.85;}
</style>
}
<div class="ai-msg">
  <div class="orb a"></div><div class="orb b"></div><div class="orb c"></div>

  <div class="head">
    <div class="head-left">
      <div class="badge"><span>‚úâÔ∏è</span></div>
      <div class="titles">
        <h1>Mesajlar</h1>
        <p>Inbox ‚Ä¢ Archive ‚Ä¢ Trash ‚Ä¢ popup detay</p>
      </div>
    </div>

    <button type="button" class="btn-add" id="btnNew">‚ûï Yeni Mesaj</button>
  </div>

  <div class="glass">
    <div class="toolbar">
      <div class="row">
        <div class="search">
          <span>üîé</span>
          <input id="q" type="text" placeholder="ƒ∞sim, mail, subject, mesaj..." autocomplete="off" />
        </div>

        <!-- ‚úÖ client-side tabs -->
        <div class="tabs">
          <button type="button" class="tab active" data-tab="inbox">Hepsi <span class="count-pill" id="cntInbox">0</span></button>
          <button type="button" class="tab" data-tab="archive">Ar≈üiv <span class="count-pill" id="cntArchive">0</span></button>
          <button type="button" class="tab" data-tab="trash">√á√∂p <span class="count-pill" id="cntTrash">0</span></button>
        </div>
      </div>
    </div>

    <div class="list" id="list">
      @if(Model != null && Model.Any())
      {
        foreach(var m in Model)
        {
          var initial = string.IsNullOrWhiteSpace(m.FullName) ? "?" : m.FullName.Trim().Substring(0,1).ToUpper();
          var snippet = (m.Email ?? "");
          if(snippet.Length > 120) snippet = snippet.Substring(0,120) + "...";

          // ‚úÖ default inbox in UI (front-only)
          <div class="item"
               data-ui-box="inbox"
               data-id="@m.ContactId"
               data-name="@m.Subject"
               data-mail="@m.Email"
               data-subject="@m.Subject"
               data-body="@m.Message"
               data-date="@m.GetDate.ToString("yyyy-MM-dd HH:mm")"
               data-read="@m.IsRead.ToString().ToLower()">

            <div class="avatar">@initial</div>

            <div class="meta">
              <div class="line1">
                <div class="name">@m.FullName</div>
                <div class="mail">‚Ä¢ @m.Email</div>
              </div>
              <div class="subj">@m.Subject</div>
              <div class="snip">@snippet</div>
            </div>

            <div class="right">
              <div class="tag @(m.IsRead ? "" : "unread")">@(m.IsRead ? "Okundu" : "Yeni")</div>
              <a href="/Message/MessageDetail/@m.ContactId" class="btnMini purple">
  üëÅ Mesajƒ± A√ß
</a>


              <button class="btnMini purple js-archive" type="button">Ar≈üivle</button>
              <button class="btnMini danger js-trash" type="button" data-id="@m.ContactId">√á√∂pe Ta≈üƒ±</button>
            </div>
          </div>
        }
      }
      else
      {
        <div style="padding:2rem;color:rgba(255,255,255,.7);font-weight:800">
          Mesaj yok.
        </div>
      }
    </div>
  </div>

  <!-- Detail Modal -->
  <div class="backdrop" id="bd">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="m-head">
        <p class="m-title">Mesaj Detay</p>
        <div class="m-close" id="mClose">‚úñ</div>
      </div>

      <div class="m-body">
        <div class="card">
          <div class="kv">
            <div class="k">ƒ∞sim</div><div class="v" id="dName">-</div>
            <div class="k">Mail</div><div class="v" id="dMail">-</div>
            <div class="k">Subject</div><div class="v" id="dSubj">-</div>
            <div class="k">Tarih</div><div class="v" id="dDate">-</div>
          </div>
          <div style="height:10px"></div>
          <div class="k" style="margin-bottom:.35rem">Mesaj</div>
          <div class="v" id="dBody" style="white-space:pre-wrap;line-height:1.6;opacity:.92"></div>
        </div>

        <div class="card">
          <div class="k" style="margin-bottom:.35rem">Cevap (AI / Manual)</div>
          <textarea class="textarea" id="replyBox" placeholder="Buraya AI otomatik cevap gelecek..."></textarea>

          <div class="m-actions">
            <button type="button" class="btnMini purple" id="btnAI">ü§ñ AI oto mesaj cevapla</button>
            <button type="button" class="btnMini primary" id="btnSend">üì© Sent mesaj</button>
          </div>

          <div style="margin-top:.8rem;color:rgba(255,255,255,.65);font-weight:700;font-size:.85rem">
            (Frontend demo) ≈ûimdilik butonlar sadece UI toast verir.
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- New Message Modal (UI only) -->
  <div class="backdrop" id="bdNew">
    <div class="modal">
      <div class="m-head">
        <p class="m-title">Yeni Mesaj Ekle</p>
        <div class="m-close" id="nClose">‚úñ</div>
      </div>

      <div class="m-body" style="grid-template-columns:1fr;">
        <div class="card">
          <div class="kv" style="grid-template-columns:120px 1fr;">
            <div class="k">ƒ∞sim</div><input class="textarea" style="min-height:auto;height:46px" id="nName" />
            <div class="k">Mail</div><input class="textarea" style="min-height:auto;height:46px" id="nMail" />
            <div class="k">Subject</div><input class="textarea" style="min-height:auto;height:46px" id="nSubj" />
            <div class="k">Mesaj</div><textarea class="textarea" id="nBody"></textarea>
          </div>

          <div class="m-actions">
            <button type="button" class="btnMini primary" id="nAdd">‚ûï Ekle</button>
            <button type="button" class="btnMini" id="nCancel">Vazge√ß</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div class="toast" id="toast">
    <div>
      <p class="t-title" id="tTitle">Vaooo ‚ú®</p>
      <p class="t-desc" id="tDesc">ƒ∞≈ülem tamamlandƒ±.</p>
    </div>
    <div class="x" id="tClose">‚úñ</div>
  </div>
</div>

@section Scripts{
<script>
(() => {
  // =========================
  // Toast
  // =========================
  const toastEl = document.getElementById("toast");
  const tTitle  = document.getElementById("tTitle");
  const tDesc   = document.getElementById("tDesc");
  const tClose  = document.getElementById("tClose");

  function toast(desc, title="Vaooo ‚ú®"){
    if(tTitle) tTitle.textContent = title;
    if(tDesc)  tDesc.textContent  = desc || "";
    toastEl?.classList.add("show");
    clearTimeout(window.__t);
    window.__t = setTimeout(()=>toastEl?.classList.remove("show"), 2200);
  }
  tClose?.addEventListener("click", ()=>toastEl?.classList.remove("show"));

  // =========================
  // Elements
  // =========================
  const q     = document.getElementById("q");
  const list  = document.getElementById("list");
  const tabs  = Array.from(document.querySelectorAll(".tab[data-tab]"));

  const cntInbox   = document.getElementById("cntInbox");   // Hepsi
  const cntArchive = document.getElementById("cntArchive");
  const cntTrash   = document.getElementById("cntTrash");

  let activeTab = "inbox"; // inbox = Hepsi (trash olmayanlar)

  function allItems(){
    return Array.from(list?.querySelectorAll(".item") || []);
  }

  // =========================
  // TRASH DATA (server)
  // =========================
  let trashData = []; // serverd…ôn g…ôl…ôn list

  async function fetchTrashList(){
    try{
      const r = await fetch("/Message/MessageTrashList", {
        method: "GET",
        headers: { "Accept":"application/json" },
        credentials: "same-origin"
      });

      const ct = (r.headers.get("content-type") || "").toLowerCase();
      const text = await r.text();

      if(!r.ok){
        console.error("TrashList HTTP:", r.status, text);
        throw new Error("HTTP " + r.status);
      }

      // JSON deyils…ô: dem…ôli controller View/Redirect qaytarƒ±r
      if(!ct.includes("application/json")){
        console.error("TrashList JSON deyil. Content-Type:", ct, "Body:", text.slice(0,300));
        throw new Error("TrashList JSON deyil (controller View qaytarƒ±r?)");
      }

      trashData = JSON.parse(text) || [];
      return trashData;
    }catch(err){
      console.error("fetchTrashList ERROR:", err);
      toast("TrashList gelmedi. Console-a bax.", "Hopp üòÖ");
      return null;
    }
  }

  // =========================
  // Render helpers
  // =========================
  function escapeHtml(str){
    return (str || "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function makeItemDto(m, box="trash"){
    const id = m.contactId ?? m.ContactId ?? m.id ?? m.Id ?? "";
    const fullName = m.fullName ?? m.FullName ?? "-";
    const email = m.email ?? m.Email ?? "-";
    const subject = m.subject ?? m.Subject ?? "-";
    const message = m.message ?? m.Message ?? "";
    const getDate = m.getDate ?? m.GetDate ?? m.date ?? m.Date ?? "";
    const isRead = (m.isRead ?? m.IsRead ?? false) ? true : false;

    const initial = (fullName || "?").trim().slice(0,1).toUpperCase() || "?";
    const snip = message.length > 120 ? (message.slice(0,120)+"...") : message;

    const div = document.createElement("div");
    div.className = "item";
    div.setAttribute("data-ui-box", box);
    div.setAttribute("data-id", id);
    div.setAttribute("data-name", fullName);
    div.setAttribute("data-mail", email);
    div.setAttribute("data-subject", subject);
    div.setAttribute("data-body", message);
    div.setAttribute("data-date", getDate ? String(getDate).replace("T"," ").slice(0,16) : "");
    div.setAttribute("data-read", isRead ? "true" : "false");

    div.innerHTML = `
      <div class="avatar">${escapeHtml(initial)}</div>
      <div class="meta">
        <div class="line1">
          <div class="name">${escapeHtml(fullName)}</div>
          <div class="mail">‚Ä¢ ${escapeHtml(email)}</div>
        </div>
        <div class="subj">${escapeHtml(subject)}</div>
        <div class="snip">${escapeHtml(snip)}</div>
      </div>
      <div class="right">
        <div class="tag ${isRead ? "" : "unread"}">${isRead ? "Okundu" : "Yeni"}</div>
        <a href="/Message/MessageDetail/${encodeURIComponent(id)}" class="btnMini purple">üëÅ Mesajƒ± A√ß</a>
      </div>
    `;

    renderButtonsFor(div);
    return div;
  }

  function renderTrashList(){
    // listi bo≈üalt, trashData render et
    list.innerHTML = "";

    if(!trashData || trashData.length === 0){
      list.innerHTML = `<div style="padding:2rem;color:rgba(255,255,255,.7);font-weight:800">√á√∂p bo≈ü.</div>`;
      return;
    }

    const frag = document.createDocumentFragment();
    trashData.forEach(m => frag.appendChild(makeItemDto(m, "trash")));
    list.appendChild(frag);
  }

  // =========================
  // Counts
  // =========================
  function updateCounts(){
    // Hepsi/Archive counts DOM-dan, Trash count server datadan
    const items = allItems();

    const trashCount = Array.isArray(trashData) ? trashData.length : 0;

    // Hepsi: trash olmayanlar (DOM)
    const hepsi = items.filter(x => (x.getAttribute("data-ui-box") || "inbox") !== "trash").length;
    const arch  = items.filter(x => (x.getAttribute("data-ui-box") || "inbox") === "archive").length;

    if(cntInbox)   cntInbox.textContent   = hepsi;
    if(cntArchive) cntArchive.textContent = arch;
    if(cntTrash)   cntTrash.textContent   = trashCount;
  }

  // =========================
  // Filter + Tab
  // =========================
  function applyUI(){
    const query = (q?.value || "").trim().toLowerCase();

    // Trash tabƒ±nda DOM filter yox, trash render edirik
    if(activeTab === "trash"){
      // trash list artƒ±q render olunubsa, sad…ôc…ô search filter t…ôtbiq ed…ôk
      allItems().forEach(it => {
        const txt = (
          (it.getAttribute("data-name")||"") + " " +
          (it.getAttribute("data-mail")||"") + " " +
          (it.getAttribute("data-subject")||"") + " " +
          (it.getAttribute("data-body")||"")
        ).toLowerCase();
        it.style.display = (!query || txt.includes(query)) ? "" : "none";
      });
      updateCounts();
      return;
    }

    // Inbox/Archive: DOM-da filter
    allItems().forEach(it => {
      const box = it.getAttribute("data-ui-box") || "inbox";

      const txt = (
        (it.getAttribute("data-name")||"") + " " +
        (it.getAttribute("data-mail")||"") + " " +
        (it.getAttribute("data-subject")||"") + " " +
        (it.getAttribute("data-body")||"")
      ).toLowerCase();

      const okSearch = (!query || txt.includes(query));

      // Hepsi = trash olmayanlar
      const okTab =
        activeTab === "inbox"   ? (box !== "trash") :
        activeTab === "archive" ? (box === "archive") :
        true;

      it.style.display = (okTab && okSearch) ? "" : "none";
    });

    updateCounts();
  }

  q?.addEventListener("input", applyUI);

  async function setActiveTab(tabName){
    activeTab = tabName;

    tabs.forEach(x => x.classList.toggle("active", (x.getAttribute("data-tab") === tabName)));

    if(tabName === "trash"){
      await fetchTrashList();
      renderTrashList();
      applyUI();
      toast("√á√∂p listesi y√ºklendi.");
      return;
    }

    // Trash tabƒ±ndan √ßƒ±xanda s…ôhif…ôni yenid…ôn serverd…ôn reload etmirs…ôn,
    // √ß√ºnki bu View server-side inbox model il…ô g…ôlir.
    // Sad…ôc…ô filter i≈ül…ôsin.
    applyUI();
    toast(`≈ûu an: ${tabName.toUpperCase()}`);
  }

  tabs.forEach(t => {
    t.addEventListener("click", () => {
      const tabName = t.getAttribute("data-tab") || "inbox";
      setActiveTab(tabName);
    });
  });

  // =========================
  // Modal detail
  // =========================
  const bd      = document.getElementById("bd");
  const mClose  = document.getElementById("mClose");
  const dName   = document.getElementById("dName");
  const dMail   = document.getElementById("dMail");
  const dSubj   = document.getElementById("dSubj");
  const dDate   = document.getElementById("dDate");
  const dBody   = document.getElementById("dBody");
  const replyBox= document.getElementById("replyBox");
  const btnAI   = document.getElementById("btnAI");
  const btnSend = document.getElementById("btnSend");

  function openModal(payload){
    dName.textContent = payload.name || "-";
    dMail.textContent = payload.mail || "-";
    dSubj.textContent = payload.subject || "-";
    dDate.textContent = payload.date || "-";
    dBody.textContent = payload.body || "";
    bd?.classList.add("show");
  }
  function closeModal(){ bd?.classList.remove("show"); }
  mClose?.addEventListener("click", closeModal);
  bd?.addEventListener("click", (e)=>{ if(e.target === bd) closeModal(); });

  document.addEventListener("click", (e)=>{
    const it = e.target.closest(".item");
    if(!it) return;

    if(
      e.target.closest(".js-archive") ||
      e.target.closest(".js-trash") ||
      e.target.closest(".js-restore") ||
      e.target.closest(".js-deleteforever")
    ) return;

    openModal({
      name: it.getAttribute("data-name"),
      mail: it.getAttribute("data-mail"),
      subject: it.getAttribute("data-subject"),
      body: it.getAttribute("data-body"),
      date: it.getAttribute("data-date")
    });

    const tag = it.querySelector(".tag");
    if(tag && tag.classList.contains("unread")){
      tag.classList.remove("unread");
      tag.textContent = "Okundu";
      toast("Okundu olarak i≈üaretlendi.");
    }
  });

  btnAI?.addEventListener("click", ()=>{
    const name = dName.textContent || "";
    const subj = dSubj.textContent || "";
    replyBox.value =
`Merhaba ${name},

Mesajƒ±nƒ±zƒ± aldƒ±k: ‚Äú${subj}‚Äù.
En kƒ±sa s√ºrede d√∂n√º≈ü yapacaƒüƒ±z.

Te≈üekk√ºrler.`;
    toast("AI cevap hazƒ±rlandƒ±.");
  });

  btnSend?.addEventListener("click", ()=>{
    const txt = (replyBox.value || "").trim();
    if(!txt){ toast("Cevap bo≈ü olamaz.", "Hopp üòÖ"); return; }
    toast("Sent ‚úÖ (≈üimdilik UI demo)");
    closeModal();
  });

  // =========================
  // Action buttons
  // =========================
  function renderButtonsFor(it){
    const right = it.querySelector(".right");
    if(!right) return;

    // yalnƒ±z button-larƒ± sil (a link qalsƒ±n)
    right.querySelectorAll("button").forEach(b => b.remove());

    const box = it.getAttribute("data-ui-box") || "inbox";

    if(box !== "trash"){
      const b1 = document.createElement("button");
      b1.type = "button";
      b1.className = "btnMini purple js-archive";
      b1.textContent = "Ar≈üivle";

      const b2 = document.createElement("button");
      b2.type = "button";
      b2.className = "btnMini danger js-trash";
      b2.textContent = "√á√∂pe Ta≈üƒ±";

      right.appendChild(b1);
      right.appendChild(b2);
    }else{
      const b3 = document.createElement("button");
      b3.type = "button";
      b3.className = "btnMini purple js-restore";
      b3.textContent = "Geri Al";

      const b4 = document.createElement("button");
      b4.type = "button";
      b4.className = "btnMini danger js-deleteforever";
      b4.textContent = "Kalƒ±cƒ± Sil";

      right.appendChild(b3);
      right.appendChild(b4);
    }
  }

  // initial DOM items button render
  allItems().forEach(renderButtonsFor);

  // =========================
  // API call: Trash
  // =========================
  async function apiTrash(id){
    const url = `http://localhost:5289/api/Contacts/message/MessageTrash?id=${encodeURIComponent(id)}`;
    const r = await fetch(url, { method:"POST", headers:{ "Accept":"application/json" } });
    const text = await r.text();
    if(!r.ok) throw new Error(`HTTP ${r.status}: ${text}`);

    try { return JSON.parse(text); }
    catch { return { success:true, message:"√á√∂p kutusuna ta≈üƒ±ndƒ±." }; }
  }

  // =========================
  // Click actions
  // =========================
  document.addEventListener("click", async (e)=>{
    const it = e.target.closest(".item");
    if(!it) return;

    const btnArchive = e.target.closest(".js-archive");
    const btnTrash   = e.target.closest(".js-trash");
    const btnRestore = e.target.closest(".js-restore");
    const btnForever = e.target.closest(".js-deleteforever");

    // ARCHIVE (UI)
    if(btnArchive){
      e.preventDefault();
      it.setAttribute("data-ui-box","archive");
      renderButtonsFor(it);
      toast("Ar≈üive ta≈üƒ±ndƒ±.");
      applyUI();
      return;
    }

    // TRASH (server + refresh trash list)
    if(btnTrash){
      e.preventDefault();

      const id = it.getAttribute("data-id");
      if(!id){ toast("Id tapƒ±lmadƒ±.", "Hopp üòÖ"); return; }

      btnTrash.disabled = true;
      try{
        const res = await apiTrash(id);
        if(res && res.success === false){
          toast(res.message || "Hata", "Hopp üòÖ");
          btnTrash.disabled = false;
          return;
        }

        // UI: elementi trash-a al (hepsi tabƒ±nda g√∂r√ºnm…ôsin)
        it.setAttribute("data-ui-box","trash");

        toast(res?.message || "√á√∂p kutusuna ta≈üƒ±ndƒ±.");

        // trash tabƒ± a√ßƒ±qdƒ±rsa yenil…ô
        if(activeTab === "trash"){
          await fetchTrashList();
          renderTrashList();
        }else{
          // counts update
          await fetchTrashList();
        }

        applyUI();
      }catch(err){
        console.error("TRASH ERROR:", err);
        toast("Sunucu hatasƒ±: Console'a bak", "Hopp üòÖ");
        btnTrash.disabled = false;
      }
      return;
    }

    // RESTORE (UI only) ‚Äî ist…ôs…ôn backend restore endpoint …ôlav…ô ed…ôrik
    if(btnRestore){
      e.preventDefault();
      it.setAttribute("data-ui-box","inbox");
      renderButtonsFor(it);
      toast("Geri alƒ±ndƒ± (UI).");
      applyUI();
      return;
    }

    // FOREVER (UI) ‚Äî real silm…ôk ist…ôyirs…ôns…ô backend endpoint yazƒ±lmalƒ±dƒ±r
    if(btnForever){
      e.preventDefault();
      if(!confirm("Kalƒ±cƒ± silinsin mi?")) return;
      it.remove();

      // trashData-dan da √ßƒ±xart
      const id = it.getAttribute("data-id");
      trashData = (trashData || []).filter(x => String(x.contactId ?? x.ContactId ?? x.id ?? x.Id) !== String(id));

      updateCounts();
      toast("Kalƒ±cƒ± silindi (UI).");
      return;
    }
  });

  // =========================
  // New message modal (UI only) ‚Äî s…ônd…ô olduƒüu kimi qalsƒ±n
  // =========================
  const bdNew   = document.getElementById("bdNew");
  const btnNew  = document.getElementById("btnNew");
  const nClose  = document.getElementById("nClose");
  const nCancel = document.getElementById("nCancel");
  const nAdd    = document.getElementById("nAdd");
  const nName   = document.getElementById("nName");
  const nMail   = document.getElementById("nMail");
  const nSubj   = document.getElementById("nSubj");
  const nBody   = document.getElementById("nBody");

  const openNew  = ()=> bdNew?.classList.add("show");
  const closeNew = ()=> bdNew?.classList.remove("show");

  btnNew?.addEventListener("click", openNew);
  nClose?.addEventListener("click", closeNew);
  nCancel?.addEventListener("click", closeNew);
  bdNew?.addEventListener("click", (e)=>{ if(e.target === bdNew) closeNew(); });

  nAdd?.addEventListener("click", ()=>{
    const name = (nName?.value || "").trim();
    const mail = (nMail?.value || "").trim();
    const subject = (nSubj?.value || "").trim();
    const body = (nBody?.value || "").trim();

    if(!name || !mail || !subject || !body){
      toast("Alanlar bo≈ü olamaz.", "Hopp üòÖ");
      return;
    }

    const id = "ui-" + Math.random().toString(16).slice(2);
    const date = new Date().toISOString().slice(0,16).replace("T"," ");

    const div = document.createElement("div");
    div.className = "item";
    div.setAttribute("data-ui-box","inbox");
    div.setAttribute("data-id", id);
    div.setAttribute("data-name", name);
    div.setAttribute("data-mail", mail);
    div.setAttribute("data-subject", subject);
    div.setAttribute("data-body", body);
    div.setAttribute("data-date", date);
    div.setAttribute("data-read", "false");

    div.innerHTML = `
      <div class="avatar">${escapeHtml((name||"?").slice(0,1).toUpperCase())}</div>
      <div class="meta">
        <div class="line1">
          <div class="name">${escapeHtml(name)}</div>
          <div class="mail">‚Ä¢ ${escapeHtml(mail)}</div>
        </div>
        <div class="subj">${escapeHtml(subject)}</div>
        <div class="snip">${escapeHtml(body.length>120 ? body.slice(0,120)+"..." : body)}</div>
      </div>
      <div class="right">
        <div class="tag unread">Yeni</div>
      </div>
    `;

    renderButtonsFor(div);
    list?.prepend(div);

    nName.value=""; nMail.value=""; nSubj.value=""; nBody.value="";
    closeNew();
    toast("Yeni mesaj eklendi.");
    applyUI();
  });

  // =========================
  // Init
  // =========================
  (async function init(){
    // trash count dolsun dey…ô bir d…ôf…ô √ß…ôk…ôk
    await fetchTrashList();
    updateCounts();
    applyUI();
  })();

})();
</script>
}
